var Updraft;!function(e){function t(e,t){return 0===e.lastIndexOf(t,0)}function n(e){var t;if(null===e||"object"!=typeof e)return e;if(e instanceof Array){t=[];for(var r=0,o=e.length;o>r;r++)t[r]=n(e[r]);return t}if(e instanceof Object&&"Object"!==e.constructor.name)return e;if(e instanceof Object&&"Object"===e.constructor.name){t={};for(var s in e)e.hasOwnProperty(s)&&(t[s]=n(e[s]));return t}throw new Error("Unable to copy obj! Its type isn't supported.")}function r(t){return t instanceof e.Instance?t._primaryKey():"object"==typeof t&&"function"==typeof t.toString?t.toString():t}function o(t,n){console.assert("function"==typeof t),console.assert("object"==typeof n),t.prototype=Object.create(e.Instance.prototype),t.prototype.constructor=t;for(var r in n){var o=n[r];"function"==typeof o?t.prototype[r]=o:t[r]=n[r]}return t}e.startsWith=t,e.clone=n,e.keyOf=r,e.createClass=o}(Updraft||(Updraft={}));var Updraft;!function(e){var t;!function(e){e[e.saved=2]="saved",e[e.added=4]="added",e[e.removed=8]="removed"}(t||(t={}));var n=function(){function n(e){this._dirtyFcn=e,this._states={}}return n.prototype.initFromDb=function(e){for(var n=0;n<e.rows.length;n++){var r=e.rows.item(n);console.assert(1===Object.keys(r).length);var o=r[Object.keys(r)[0]];this._states[o]=t.saved}},n.prototype.assign=function(e){this.clear(),this.add.apply(this,e)},n.prototype.clear=function(){for(var e in this._states)this._states[e]=t.removed},n.prototype.add=function(){for(var n=[],r=0;r<arguments.length;r++)n[r-0]=arguments[r];var o=!1,s=this;n.map(e.keyOf).forEach(function(e){console.assert("object"!=typeof e),s._states[e]!==t.saved&&(s._states[e]=t.added,o=!0)}),o&&this._dirtyFcn()},n.prototype.push=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];return this.add.apply(this,e)},n.prototype.remove=function(){for(var n=[],r=0;r<arguments.length;r++)n[r-0]=arguments[r];var o=!1,s=this;n.map(e.keyOf).forEach(function(e){s._states[e]=t.removed,o=!0}),o&&this._dirtyFcn()},n.prototype.which=function(e){var t=this;return Object.keys(this._states).filter(function(n,r,o){return t._states[n]&e?!0:!1})},n.prototype.values=function(){return this.which(t.saved|t.added)},n.prototype.getAdded=function(){return this.which(t.added)},n.prototype.getRemoved=function(){return this.which(t.removed)},n.prototype.clearChanges=function(){var e={};for(var n in this._states)this._states[n]!==t.removed&&(e[n]=t.saved);this._states=e},n}();e.Set=n}(Updraft||(Updraft={}));var Updraft;!function(e){var t=function(){function t(e,t){console.assert(null!=e),console.assert(null!=t),this._model=e,this._store=t,this._justCount=!1,this._tables=[e.tableName],this._columns=[],this._conditions=[],this._order=void 0,this._limit=void 0,this._offset=void 0,this._asc=!0,this._nocase=!1;for(var n in e.columns)10!==e.columns[n].type&&this._columns.push(e.tableName+"."+n)}return t.prototype.all=function(){return this.get()},t.prototype.addCondition=function(t,n,r,o){var s,a=n.split(/\./),i=this._model;o=e.keyOf(o);for(var c=0;c<a.length-1;c++){s=a[c],console.assert(s in i.columns);var u=i.columns[s].ref;console.assert(null!=u),-1===this._tables.indexOf(u.tableName)&&(this._tables.push(u.tableName),this._conditions.push({conj:"AND",col:i.tableName+"."+s,op:"=",val:u.tableName+"."+u.key})),i=u}switch(s=a[a.length-1],r){case"contains":console.assert(10===i.columns[s].type);var l=i.columns[s].setTable;console.assert(null!=l),-1===this._tables.indexOf(l.tableName)&&(this._tables.push(l.tableName),this._conditions.push({conj:"AND",col:i.tableName+"."+i.key,op:"=",val:l.tableName+"."+i.key})),this._conditions.push({conj:t,col:l.tableName+"."+s,op:"=",val:"?",arg:o});break;default:console.assert(10!==i.columns[s].type),this._conditions.push({conj:t,col:i.tableName+"."+s,op:r,val:"?",arg:o})}return this},t.prototype.and=function(e,t,n){return this.addCondition("AND",e,t,n)},t.prototype.where=function(){return this.and.apply(this,arguments)},t.prototype.or=function(e,t,n){return this.addCondition("OR",e,t,n)},t.prototype.order=function(e,t){return this._order=this._model.tableName+"."+e,"undefined"!=typeof t&&(this._asc=t),this},t.prototype.nocase=function(){return this._nocase=!0,this},t.prototype.limit=function(e){return this._limit=e,this},t.prototype.offset=function(e){return this._offset=e,this},t.prototype.count=function(){return this._justCount=!0,this.get()},t.prototype.get=function(){var t="COUNT(*)",n="SELECT ",r=this._model;n+=this._justCount?t:this._columns.join(", "),n+=" FROM "+this._tables.join(", ");for(var o=[],s=0;s<this._conditions.length;s++){var a=this._conditions[s];n+=0===s?" WHERE ":" "+a.conj+" ",n+=a.col+" "+a.op+" "+a.val,"arg"in a&&o.push(a.arg)}this._order&&(n+=" ORDER BY "+this._order,n+=this._nocase?" COLLATE NOCASE":"",n+=this._asc?" ASC":" DESC"),console.assert(!this._offset||this._limit),this._limit&&(n+=" LIMIT "+this._limit,this._offset&&(n+=" OFFSET "+this._offset));var i=[],c=this;return this._store.execRead(n,o,function(n,o){if(c._justCount)return o.rows.item(0)[t];for(var s=0;s<o.rows.length;s++){var a=e.constructFromDb(r,o.rows.item(s));i.push(a)}var u=Object.keys(r.columns).filter(function(e){return 10===r.columns[e].type});return Promise.all(i.map(function(e){return Promise.all(u.map(function(t){var o=r.columns[t].setTable;console.assert(null!=o);var s=e._primaryKey(),a="SELECT "+t;return a+=" FROM "+o.tableName,a+=" WHERE "+c._model.key+" = ?",c._store.exec(n,a,[s],function(n,r){r.rows.length>0&&e[t].initFromDb(r)})}))})).then(function(){return i})})},t}();e.Query=t}(Updraft||(Updraft={}));var Updraft;!function(e){function t(t,n,r,o){var s="_"+r;switch(t.columns[r].type){default:Object.defineProperty(n,r,{configurable:!0,get:function(){return this[s]},set:function(e){this[s]!==e&&(this[s]=e,this._changeMask|=o)}});break;case 9:Object.defineProperty(n,r,{configurable:!0,get:function(){var e=this._model.columns[r].ref;console.assert(null!=e.get);var t={ref:e,own:this,get:function(){return this.ref.get(this.own[s])}};return t[e.key]=this[s],t},set:function(t){t=e.keyOf(t),this[s]!==t&&(this[s]=t,this._changeMask|=o)}});break;case 10:Object.defineProperty(n,r,{configurable:!0,get:function(){if(!(s in this)){var t=this;this[s]=new e.Set(function(){t._changeMask|=o})}return this[s]},set:function(t){if(!(s in this)){var n=this;this[s]=new e.Set(function(){n._changeMask|=o})}this[s].assign(t),this._changeMask|=o}})}}function n(n,r){console.assert(null!=r),console.assert(null!=n),console.assert(null!=n.tableName),console.assert("_"!==n.tableName[0]),console.assert(null!=n.columns),console.assert(Object.keys(n.columns).length<64),console.assert(!("changes"in n.columns)),console.assert(!("template"in n.columns)),console.assert(!n.renamedColumns||Object.keys(n.renamedColumns).every(function(e){return!(e in n.columns)}));var o=n.prototype;Object.defineProperty(o,"_model",{configurable:!0,enumerable:!0,value:n}),Object.defineProperty(o,"_store",{configurable:!0,enumerable:!0,value:r}),n.get=function(e){return this.all.where(this.key,"=",e).get().then(function(e){return console.assert(e.length<2),0===e.length?null:e[0]})},Object.defineProperty(n,"all",{configurable:!0,get:function(){return new e.Query(this,r)}}),n.indices=n.indices||[];var s=null,a=null,i=0;for(var c in n.columns){n.columns[c].isKey&&(s=c,a=n.columns[c].type),n.columns[c].isIndex&&n.indices.push([c]);var u=1<<i++;if(t(n,o,c,u),i>=63)throw new Error("class has too many columns- max 63")}console.assert(null!=s),n.key=s,n.keyType=a}function r(e,t){var n=new e;console.assert(n instanceof o);for(var r in t){var s=t[r],a="_"+r;switch(e.columns[r].type){case 8:n[a]=JSON.parse(s);break;case 6:case 7:n[a]=new Date(1e3*s);break;case 5:var i=n._model.columns[r]["enum"];console.assert(null!=i),"object"==typeof i&&"function"==typeof i.get?n[a]=i.get(s):(console.assert(s in i),n[a]=i[s]);break;case 10:n[a].push(s);break;default:n[a]=s}}return n._isInDb=!0,console.assert(0===n._changeMask),n}var o=function(){function e(t){var n=this;n._changeMask=0,t=t||{};for(var r in t){var o=t[r];o instanceof e&&(o=o._primaryKey()),n[r]=o}}return e.prototype._primaryKey=function(){var e="_"+this._model.key;return console.assert(e in this),this[e]},e.prototype._changes=function(){var e=[],t=0;for(var n in this._model.columns){var r=1<<t++;this._changeMask&r&&e.push(n)}return e},e.prototype._clearChanges=function(){this._changeMask=0;for(var e in this._model.columns)e in this&&"undefined"!=typeof this[e]&&"function"==typeof this[e].clearChanges&&this[e].clearChanges()},e}();e.Instance=o,e.MakeClassTemplate=n,e.constructFromDb=r}(Updraft||(Updraft={}));var __extends=this.__extends||function(e,t){function n(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);n.prototype=t.prototype,e.prototype=new n},Updraft;!function(e){function t(e,t){}!function(e){e[e["int"]=0]="int",e[e.real=1]="real",e[e.bool=2]="bool",e[e.text=3]="text",e[e.blob=4]="blob",e[e["enum"]=5]="enum",e[e.date=6]="date",e[e.datetime=7]="datetime",e[e.json=8]="json",e[e.ptr=9]="ptr",e[e.set=10]="set"}(e.ColumnType||(e.ColumnType={}));var n=(e.ColumnType,function(){function e(e){this.type=e}return e.prototype.Key=function(e){return void 0===e&&(e=!0),this.isKey=e,this},e.prototype.Index=function(e){return void 0===e&&(e=!0),this.isIndex=e,this},e.prototype.Default=function(e){return this.defaultValue=e,this},e.Int=function(){return new e(0)},e.Real=function(){return new e(1)},e.Bool=function(){return new e(2)},e.Text=function(){return new e(3)},e.String=function(){return new e(3)},e.Blob=function(){var t=new e(4);return t},e.Enum=function(t){var n=new e(5);return n["enum"]=t,n},e.Date=function(){return new e(6)},e.DateTime=function(){return new e(7)},e.JSON=function(){return new e(8)},e.Ptr=function(t){var n=new e(9);return n.ref=t,n},e.Set=function(t){var n=new e(10);return n.ref=t,n},e.sqlType=function(e){switch(e){case 0:return"INTEGER";case 2:return"BOOL";case 1:return"REAL";case 3:case 8:case 5:return"TEXT";case 4:return"BLOB";case 6:return"DATE";case 7:return"DATETIME";default:throw new Error("unsupported type")}},e}());e.Column=n;var r=function(){function e(){}return e}();e.StoreOptions=r;var o=function(){function e(){}return e}();e.Schema=o;var s=function(){function e(){}return e}();e.SchemaTable=s;var a=function(e){function t(t){e.call(this,t)}return __extends(t,e),t.get=function(e){return null},t.tableName="updraft_kv",t.columns={key:n.String().Key(),value:n.String()},t}(e.Instance),i=function(){function r(){var e=this;this.logSql=!1,e.tables=[],e.kv={},this.addClass(a)}return r.prototype.addClass=function(t){e.MakeClassTemplate(t,this),this.tables.push(t)},r.prototype.set=function(e,t){this.kv[e]=t;var n=new a({key:e,value:JSON.stringify(t)});return this.save(n)},r.prototype.get=function(e){return this.kv[e]},r.prototype.loadKeyValues=function(){var e=this;return a.all.get().then(function(t){for(var n=0;n<t.length;n++){var r=t[n];e.kv[r.key]=JSON.parse(r.value)}})},r.prototype.purge=function(e){console.assert(!this.db),this.db=window.openDatabase(e.name,"1.0","updraft created database",5242880),console.assert(null!=this.db);var t=this;return console.assert(this instanceof r),t.readSchema().then(function(e){return new Promise(function(n,r){t.db.transaction(function(o){var s=[];return Object.keys(e).forEach(function(e){s.push(t.exec(o,"DROP TABLE "+e))}),Promise.all(s).then(function(){t.db=null}).then(n,r)})})})},r.prototype.open=function(e){this.db=window.openDatabase(e.name,"1.0","updraft created database",5242880),console.assert(null!=this.db);for(var t=[],o=0;o<this.tables.length;o++){var s=this.tables[o];for(var a in s.columns)if(10===s.columns[a].type){var i=s.columns[a].ref;console.assert(null!=i);var c={tableName:s.tableName+"_"+a,recreate:s.recreate,temp:s.temp,key:"",keyType:s.keyType,columns:{},indices:[[s.key],[a]],get:function(e){throw new Error("not callable")}};c.columns[s.key]=new n(s.keyType),c.columns[a]=new n(i.keyType),s.columns[a].setTable=c,t.push(c)}}this.tables=this.tables.concat(t);var u=this;return console.assert(this instanceof r),u.readSchema().then(u.syncTables.bind(u)).then(u.loadKeyValues.bind(u))},r.prototype.close=function(){this.db=null,this.constructor()},r.prototype.exec=function(e,n,r,o){void 0===o&&(o=t),this.logSql&&console.log(n,r);var s=this;return new Promise(function(t,a){try{e.executeSql(n,r,function(e,n){var r=o?o(e,n):null;return Promise.resolve(r).then(t,a)},function(e,t){return s.reportError(t),a(t),!1})}catch(i){throw console.log('Failed to exec "'+n+'":'+i),i}})},r.prototype.execRead=function(e,t,n){var r=this;return console.assert(null!=r.db),new Promise(function(o,s){r.db.readTransaction(function(a){return r.exec(a,e,t,n).then(o,s)})})},r.prototype.reportError=function(e){switch(e.code){case e.SYNTAX_ERR:console.log("Syntax error: "+e.message);break;default:console.log(e)}},r.prototype.readSchema=function(){function t(e){var t={_indices:{},_triggers:{}},n=e.match(/\((.*)\)/);if(n)for(var r=n[1].split(","),o=0;o<r.length;o++){var s=/^\s*(primary|foreign)\s+key/i;if(!r[o].match(s)){var a=/"(.+)"\s+(.*)/,i=/(\w+)\s+(.*)/,c=r[o].match(a);c||(c=r[o].match(i)),c&&(t[c[1]]=c[2])}}return t}return this.execRead("SELECT name, tbl_name, type, sql FROM sqlite_master",[],function(n,r){for(var o={},s=0;s<r.rows.length;s++){var a=r.rows.item(s);if("_"!=a.name[0]&&!e.startsWith(a.name,"sqlite"))switch(a.type){case"table":o[a.name]=t(a.sql);break;case"index":o[a.tbl_name]._indices=o[a.tbl_name]._indices||{},o[a.tbl_name]._indices[a.name]=a.sql;break;case"trigger":o[a.tbl_name]._triggers=o[a.tbl_name]._triggers||{},o[a.tbl_name]._triggers[a.name]=a.sql}}return o})},r.prototype.syncTables=function(e){var t=this;return console.assert(null!=t.db),new Promise(function(n,r){t.db.transaction(function(o){return Promise.all(t.tables.map(function(n){return t.syncTable(o,e,n)})).then(n,r)})})},r.prototype.syncTable=function(t,r,o){function s(e){var r=[];for(var s in o.columns){var a,i=o.columns[s];switch(i.type){case 9:console.assert(null!=i.ref),console.assert(null!=i.ref.columns),console.assert(null!=i.ref.tableName),console.assert(null!=i.ref.key);var u=i.ref.columns[i.ref.key].type;a=s+" "+n.sqlType(u),r.push(a);break;case 10:break;default:a=s+" "+n.sqlType(i.type),o.key===s&&(a+=" PRIMARY KEY"),r.push(a)}}return c.exec(t,"CREATE "+(o.temp?"TEMP ":"")+"TABLE "+e+" ("+r.join(", ")+")")}function a(e){return c.exec(t,"DROP TABLE "+e)}function i(n){void 0===n&&(n=!1);var s=[],a=o.tableName in r?e.clone(r[o.tableName]._indices):{};return o.indices.forEach(function(e){var i="index_"+o.tableName+"__"+e.join("_"),u="CREATE INDEX "+i+" ON "+o.tableName+" ("+e.join(", ")+")";delete a[i];var l=!0,f=!1;r[o.tableName]&&r[o.tableName]._indices&&r[o.tableName]._indices[i]&&(r[o.tableName]._indices[i]===u?l=!1:f=!0),f&&s.push(c.exec(t,"DROP INDEX "+i)),(l||n)&&s.push(c.exec(t,u))}),Object.keys(a).forEach(function(e){s.push(c.exec(t,"DROP INDEX "+e))}),Promise.all(s)}var c=this;if(o.tableName in r){if(o.recreate)return Promise.all([a(o.tableName),s(o.tableName),i(!0)]);var u=e.clone(r[o.tableName]);delete u._indices,delete u._triggers;var l,f=[],h=!1;for(l in o.columns)l in u||(f.push(l),o.columns[l].ref&&(h=!0));var p=e.clone(o.renamedColumns)||{};for(l in Object.keys(p))l in u||delete p[l];var m=Object.keys(u).filter(function(e){return!(e in o.columns)});if(h||Object.keys(p).length>0||m.length>0){var d=function(e,n){var r=Object.keys(u).filter(function(e){return e in o.columns||e in p}),s=r.map(function(e){return e in p?p[e]:e});if(r.length&&s.length){var a="INSERT INTO "+n+" ("+s.join(", ")+") ";return a+="SELECT "+r.join(", ")+" FROM "+e+";",c.exec(t,a)}},y=function(e,n){return c.exec(t,"ALTER TABLE "+e+" RENAME TO "+n)},v="new_"+o.tableName;return console.assert(!(v in r)),Promise.all([s(v),d(o.tableName,v),a(o.tableName),y(v,o.tableName),i(!0)])}if(f.length>0){var b=[];return f.forEach(function(e){var r=o.columns[e],s=e+" "+n.sqlType(r.type);b.push(c.exec(t,"ALTER TABLE "+o.tableName+" ADD COLUMN "+s))}),b.push(i()),Promise.all(b)}return i()}return Promise.all([s(o.tableName),i(!0)])},r.prototype.save=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];e.map(function(e){console.assert("_"+e._model.key in e,"object must have a key")});var n=this;return new Promise(function(t,r){n.db.transaction(function(o){function s(e,t){var n=e["_"+t];switch(e._model.columns[t].type){case 6:case 7:"undefined"!=typeof n&&(console.assert(n instanceof Date),n=Math.floor(n.getTime()/1e3));break;case 8:n=JSON.stringify(n);break;case 5:console.assert(null!=e._model.columns[t]["enum"]),n=n.toString();break;default:console.assert("object"!=typeof n)}return n}function a(e,t){var r=e._changes(),s=e._model,a=[];return Object.keys(s.columns).filter(function(e){return 10===s.columns[e].type&&(t||r.indexOf(e)>-1)}).forEach(function(t){var r=s.columns[t].ref,i=s.columns[t].setTable;console.assert(null!=r),console.assert(null!=i);var c=e["_"+t];if(c){var u=e._primaryKey(),l=c.getRemoved(),f=c.getAdded();l.forEach(function(e){a.push(n.exec(o,"DELETE FROM "+i.tableName+" WHERE "+s.key+"=? AND "+t+"=?",[u,e]))}),f.forEach(function(e){a.push(n.exec(o,"INSERT INTO "+i.tableName+" ("+s.key+", "+t+") VALUES (?, ?)",[u,e]))})}}),Promise.all(a).then(function(){return!0})}function i(e,t){void 0===t&&(t=null);var r=e._model,a=function(e){return 10!==r.columns[e].type},i=Object.keys(r.columns).filter(a),c=i.join(", "),u=i.map(function(){return"?"}).join(", "),l=i.map(function(t){return s(e,t)});return n.exec(o,"INSERT OR IGNORE INTO "+r.tableName+" ("+c+") VALUES ("+u+")",l,function(e,n){var r=0!==n.rowsAffected;return t?t(r):r})}function c(e,t){void 0===t&&(t=null);var r=e._model,a=e._changes(),i=function(e){return 10!==r.columns[e].type},c=function(e){return e!==r.key},u=a.filter(i).filter(c).map(function(e){return e+"=?"}).join(", "),l=a.filter(i).filter(c).map(function(t){return s(e,t)});return l.push(e["_"+r.key]),n.exec(o,"UPDATE OR IGNORE "+r.tableName+" SET "+u+" WHERE "+r.key+"=?",l,function(e,n){var r=0!==n.rowsAffected;return t?t(r):r})}var u=function(e){var t;return t=e._isInDb?c(e,function(t){return t?a(e,!1):i(e)}):i(e,function(t){return t?a(e,!0):c(e)}),t.then(function(t){console.assert(t),t&&(e._clearChanges(),e._isInDb=!0)})};return Promise.all(e.map(u)).then(t,r)})})},r}();e.Store=i}(Updraft||(Updraft={}));
//# sourceMappingURL=../dist/updraft.js.map