!function e(t,n,r){function o(i,a){if(!n[i]){if(!t[i]){var c="function"==typeof require&&require;if(!a&&c)return c(i,!0);if(s)return s(i,!0);var u=new Error("Cannot find module '"+i+"'");throw u.code="MODULE_NOT_FOUND",u}var l=n[i]={exports:{}};t[i][0].call(l.exports,function(e){var n=t[i][1][e];return o(n?n:e)},l,l.exports,e,t,n,r)}return n[i].exports}for(var s="function"==typeof require&&require,i=0;i<r.length;i++)o(r[i]);return o}({"./src/main.js":[function(e,t){"use strict";var n={VERSION:"0.4.0",Store:e("./store")};t.exports=n,window&&(window.Updraft=n)},{"./store":"/Users/aolson/Developer/updraft/src/store.js"}],"/Users/aolson/Developer/updraft/src/model.js":[function(e,t){"use strict";function n(e){var t=this;t._changes=0,Object.keys(this.model.columns).forEach(function(e){"list"===t.model.columns[e].type&&(t["_"+e]=[],t["_"+e].push=function(){var n=Array.prototype.slice.call(arguments).map(function(e){return"object"==typeof e?e.key():e}),r=t["_"+e],o=Array.prototype.push.apply(r,n);return t[e]=r,o})}),e=e||{};for(var n in e)t[n]=e[n]}function r(e,t){console.assert(e),console.assert(t),console.assert(t.tableName),console.assert("_"!==t.tableName[0]),console.assert(t.columns),console.assert(Object.keys(t.columns).length<64),console.assert(!("changes"in t.columns)),console.assert(!("template"in t.columns)),console.assert(!t.renamedColumns||Object.keys(t.renamedColumns).every(function(e){return!(e in t.columns)}));var a=function(){n.apply(this,arguments)};a.prototype=Object.create(n.prototype),a.prototype.constructor=a;var c=function(e){return new a(e)};Object.setPrototypeOf(c,r.prototype),Object.defineProperty(a.prototype,"model",{enumerable:!0,value:c}),Object.defineProperty(a.prototype,"factory",{enumerable:!0,value:c}),c.ModelInstance=a,Object.defineProperty(c,"store",{enumerable:!0,value:e}),Object.defineProperty(c,"all",{get:function(){return new s(this,this.store)}}),c.indices=[];for(var u in t)c[u]=o.clone(t[u]);c.key=null,c.keyType=null;var l=0;for(var f in c.columns){c.columns[f].key&&(c.key=f,c.keyType=c.columns[f].type),c.columns[f].index&&c.indices.push([f]);var h=1<<l++;if(i(c,a.prototype,f,h),l>=63)throw new Error("class has too many columns- max 63")}return console.assert(c.key),c}var o=e("./util"),s=e("./query");n.prototype.key=function(){var e="_"+this.model.key;return console.assert(e in this),this[e]},n.prototype.changes=function(){var e=[],t=0;for(var n in this.model.columns){var r=1<<t++;this._changes&r&&e.push(n)}return e};var i=function(e,t,n,r){var o="_"+n;switch(e.columns[n].type){default:Object.defineProperty(t,n,{get:function(){return this[o]},set:function(e){this[o]!==e&&(this[o]=e,this._changes|=r)}});break;case"ptr":Object.defineProperty(t,n,{get:function(){var e=this.model.columns[n].ref;console.assert(e.get);var t={};return t.ref=e,t.own=this,t[e.key]=this[o],t.get=function(){return this.ref.get(this.own[o])},t},set:function(e){"object"==typeof e&&(e=e.key()),this[o]!==e&&(this[o]=e,this._changes|=r)}});break;case"list":Object.defineProperty(t,n,{get:function(){return this[o]},set:function(e){e=e.map(function(e){return"object"==typeof e?e.key():e}),this[o]=e,this._changes|=r}})}};r.prototype.get=function(e){return this.all.where(this.key,"=",e).get().then(function(e){return console.assert(e.length<2),0===e.length?null:e[0]})},r.prototype.constructFromDb=function(e){var t=new this.ModelInstance;for(var n in e){var r=e[n],o="_"+n;switch(this.columns[n].type){case"json":t[o]=JSON.parse(r);break;case"list":t[o].push(r);break;default:t[o]=r}}return t._isInDb=!0,console.assert(0===t._changes),t},t.exports=r},{"./query":"/Users/aolson/Developer/updraft/src/query.js","./util":"/Users/aolson/Developer/updraft/src/util.js"}],"/Users/aolson/Developer/updraft/src/query.js":[function(e,t){"use strict";var n=function(e,t){console.assert(e),console.assert(t),this._model=e,this._store=t,this._justCount=!1,this._tables=[e.tableName],this._columns=[],this._conditions=[],this._order=void 0,this._limit=void 0,this._offset=void 0,this._asc=!0,this._nocase=!1;for(var n in e.columns)"list"!==e.columns[n].type&&this._columns.push(e.tableName+"."+n)};n.prototype.all=function(){return this.get()},n.prototype.addCondition=function(e,t,n,r){for(var o=t.split(/\./),s=this._model,i=0;i<o.length-1;i++){var a=o[i];console.assert(a in s.columns);var c=s.columns[a].ref;console.assert(c),this._tables.indexOf(c.tableName)&&(this._tables.push(c.tableName),this._conditions.push({conj:"AND",col:s.tableName+"."+a,op:"=",val:c.tableName+"."+c.key})),s=c}return this._conditions.push({conj:e,col:s.tableName+"."+o[o.length-1],op:n,val:"?",arg:r}),this},n.prototype.and=function(e,t,n){return this.addCondition("AND",e,t,n)},n.prototype.where=n.prototype.and,n.prototype.or=function(e,t,n){return this.addCondition("OR",e,t,n)},n.prototype.order=function(e,t){return this._order=e,"undefined"!=typeof t&&(this._asc=t),this},n.prototype.nocase=function(){return this._nocase=!0,this},n.prototype.limit=function(e){return this._limit=e,this},n.prototype.offset=function(e){return this._offset=e,this},n.prototype.count=function(){return this._justCount=!0,this.get()},n.prototype.get=function(){var e="COUNT(*)",t="SELECT ",n=this._model;t+=this._justCount?e:this._columns.join(", "),t+=" FROM "+this._tables.join(", ");for(var r=[],o=0;o<this._conditions.length;o++){var s=this._conditions[o];t+=0===o?" WHERE ":" "+s.conj+" ",t+=s.col+" "+s.op+" "+s.val,"arg"in s&&r.push(s.arg)}this._order&&(t+=" ORDER BY "+this._order,t+=this._nocase?" COLLATE NOCASE":"",t+=this._asc?" ASC":" DESC"),console.assert(!this._offset||this._limit),this._limit&&(t+=" LIMIT "+this._limit,this._offset&&(t+=" OFFSET "+this._offset));var i=[],a=this;return this._store.execRead(t,r,function(t,r){if(a._justCount)return r.rows.item(0)[e];for(var o=0;o<r.rows.length;o++){var s=n.constructFromDb(r.rows.item(o));i.push(s)}return Promise.all(i.map(function(e){return Promise.all(Object.keys(n.columns).filter(function(e){return"list"===n.columns[e].type}).map(function(r){var o=n.columns[r].listTable;console.assert(o);var s=e.key(),i="SELECT "+r;return i+=" FROM "+o.tableName,i+=" WHERE "+a._model.key+" = ?",a._store.exec(t,i,[s],function(t,n){for(var o=0;o<n.rows.length;o++){var s=n.rows.item(o);e["_"+r].push(s[r])}e._changes=0})}))})).then(function(){return i})})},t.exports=n},{}],"/Users/aolson/Developer/updraft/src/store.js":[function(e,t){"use strict";var n=e("./util"),r=e("./model"),o=n.clone,s=n.startsWith,i={"int":"INTEGER",bool:"BOOL",real:"REAL",text:"TEXT",blob:"BLOB",date:"DATE",datetime:"DATETIME",json:"TEXT",ptr:"ref",list:"ref"},a=function(){function e(e){switch(e.code){case e.SYNTAX_ERR:console.log("Syntax error: "+e.message);break;default:console.log(e)}}function t(e){return console.assert(a.db),new Promise(function(t,r){a.db.transaction(function(o){return Promise.all(a.tables.map(function(t){return n(o,e,t)})).then(t,r)})})}function n(e,t,n){function r(t){var r=[];for(var o in n.columns){var s,c=n.columns[o];switch(console.assert(c.type in i),c.type){case"ptr":console.assert(c.ref),console.assert(c.ref.columns),console.assert(c.ref.tableName),console.assert(c.ref.key);var u=c.ref.columns[c.ref.key].type;console.assert(u in i),s=o+" "+i[u],r.push(s);break;case"list":break;default:console.assert(c.type in i),s=o+" "+i[c.type],n.key===o&&(s+=" PRIMARY KEY"),r.push(s)}}return a.exec(e,"CREATE "+(n.temp?"TEMP ":"")+"TABLE "+t+" ("+r.join(", ")+")")}function s(t){return a.exec(e,"DROP TABLE "+t)}function c(r){var s=Promise.resolve(),i=n.tableName in t?o(t[n.tableName]._indices):{};return n.indices.forEach(function(o){var c="index_"+n.tableName+"__"+o.join("_"),u="CREATE INDEX "+c+" ON "+n.tableName+" ("+o.join(", ")+")";delete i[c];var l=!0,f=!1;t[n.tableName]&&t[n.tableName]._indices&&t[n.tableName]._indices[c]&&(t[n.tableName]._indices[c]===u?l=!1:f=!0),f&&(s=s.then(a.exec(e,"DROP INDEX "+c))),(l||r)&&(s=s.then(a.exec(e,u)))}),Object.keys(i).forEach(function(t){s=s.then(a.exec(e,"DROP INDEX "+t))}),s}if(n.tableName in t){if(n.recreate)return Promise.resolve().then(s(n.tableName)).then(r(n.tableName)).then(c(!0));var u=o(t[n.tableName]);delete u._indices,delete u._triggers;var l,f=[],h=!1;for(l in n.columns)l in u||(f.push(l),n.columns[l].ref&&(h=!0));var m=o(n.renamedColumns)||{};for(l in Object.keys(m))l in u||delete m[l];var p=Object.keys(u).filter(function(e){return!(e in n.columns)});if(h||Object.keys(m).length>0||p.length>0){var y=function(t,r){var o=Object.keys(u).filter(function(e){return e in n.columns||e in m}),s=o.map(function(e){return e in m?m[e]:e}),i="INSERT INTO "+r+" ("+s.join(", ")+") ";return i+="SELECT "+o.join(", ")+" FROM "+t+";",a.exec(e,i)},d=function(t,n){return a.exec(e,"ALTER TABLE "+t+" RENAME TO "+n)},b="new_"+n.tableName;return console.assert(!(b in t)),Promise.resolve().then(r(b)).then(y(n.tableName,b)).then(s(n.tableName)).then(d(b,n.tableName)).then(c(!0))}if(f.length>0){var v=Promise.resolve();return f.map(function(t){var r=n.columns[t];console.assert(r.type in i);var o=t+" "+i[r.type];v=v.then(a.exec(e,"ALTER TABLE "+n.tableName+" ADD COLUMN "+o))}),v.then(c())}return c()}return Promise.resolve().then(r(n.tableName)).then(c(!0))}var a=this;this.tables=[],this.triggers={},this.logSql=!1,this.columnType=i,this.createClass=function(e){var t=new r(a,e);return a.tables.push(t),t},this.purge=function(e){return console.assert(!a.db),a.db=window.openDatabase(e.name,"1.0","updraft created database",5242880),console.assert(a.db),a.readSchema().then(function(e){return new Promise(function(t,n){a.db.transaction(function(r){var o=Promise.resolve();return Object.keys(e).forEach(function(e){o=o.then(a.exec(r,"DROP TABLE "+e))}),o.then(function(){a.db=null}).then(t,n)})})})},this.open=function(e){a.db=window.openDatabase(e.name,"1.0","updraft created database",5242880),console.assert(a.db);for(var n=[],r=0;r<a.tables.length;r++){var o=a.tables[r];for(var s in o.columns)if("list"===o.columns[s].type){var i=o.columns[s].ref;console.assert(i);var c={};c.tableName=o.tableName+"_"+s,c.recreate=o.recreate,c.temp=o.temp,c.key="",c.keyType=o.keyType,c.columns={},c.columns[o.key]={type:o.keyType},c.columns[s]={type:i.keyType},c.indices=[[o.key],[s]],o.columns[s].listTable=c,n.push(c)}}return a.tables=a.tables.concat(n),a.readSchema().then(t)},this.close=function(){a.db=null,a.tables=[],a.triggers={}},this.exec=function(t,n,r,o){return a.logSql&&console.log(n,r),new Promise(function(s,i){try{t.executeSql(n,r,function(e,t){var n=o?o(e,t):null;return Promise.resolve(n).then(s,i)},function(t,n){e(n),i(n)})}catch(a){throw console.log('Failed to exec "'+n+'":'+a),a}})},this.execRead=function(e,t,n){return console.assert(a.db),new Promise(function(r,o){a.db.readTransaction(function(s){return a.exec(s,e,t,n).then(r,o)})})},this.readSchema=function(){function e(e){var t={_indices:{},_triggers:{}},n=e.match(/\((.*)\)/);if(n)for(var r=n[1].split(","),o=0;o<r.length;o++){var s=/^\s*(primary|foreign)\s+key/i;if(!r[o].match(s)){var i=/"(.+)"\s+(.*)/,a=/(\w+)\s+(.*)/,c=r[o].match(i);c||(c=r[o].match(a)),c&&(t[c[1]]=c[2])}}return t}return a.execRead("SELECT name, tbl_name, type, sql FROM sqlite_master",[],function(t,n){for(var r={},o=0;o<n.rows.length;o++){var i=n.rows.item(o);if("_"!=i.name[0]&&!s(i.name,"sqlite"))switch(i.type){case"table":r[i.name]=e(i.sql);break;case"index":r[i.tbl_name]._indices=r[i.tbl_name]._indices||{},r[i.tbl_name]._indices[i.name]=i.sql;break;case"trigger":r[i.tbl_name]._triggers=r[i.tbl_name]._triggers||{},r[i.tbl_name]._triggers[i.name]=i.sql}}return r})},this.save=function(e){return e.map(function(e){console.assert("_"+e.model.key in e,"object must have a key")}),new Promise(function(t,n){a.db.transaction(function(r){function o(e,t){var n=e["_"+t];return"object"==typeof n&&(n=JSON.stringify(n)),n}function s(e,t){var n=e.changes(),o=e.model,s=[];return Object.keys(o.columns).filter(function(e){return"list"===o.columns[e].type&&(t||n.indexOf(e)>-1)}).forEach(function(t){var n=o.columns[t].ref,i=o.columns[t].listTable;console.assert(n),console.assert(i);var c=e["_"+t],u=e[o.key];s.push(a.exec(r,"DELETE FROM "+i.tableName+" WHERE "+o.key+"=?",[u])),c.forEach(function(e){s.push(a.exec(r,"INSERT INTO "+i.tableName+" ("+o.key+", "+t+") VALUES (?, ?)",[u,e]))})}),Promise.all(s)}function i(e,t){var n=e.model,s=function(e){return"list"!==n.columns[e].type},i=Object.keys(n.columns).filter(s),c=i.join(", "),u=i.map(function(){return"?"}).join(", "),l=i.map(function(t){return o(e,t)});return a.exec(r,"INSERT OR IGNORE INTO "+n.tableName+" ("+c+") VALUES ("+u+")",l,function(e,n){var r=0!==n.rowsAffected;return t?t(r):r})}function c(e,t){var n=e.model,s=e.changes(),i=function(e){return"list"!==n.columns[e].type},c=function(e){return e!==n.key},u=s.filter(i).filter(c).map(function(e){return e+"=?"}).join(", "),l=s.filter(i).filter(c).map(function(t){return o(e,t)});return l.push(e["_"+n.key]),a.exec(r,"UPDATE OR IGNORE "+n.tableName+" SET "+u+" WHERE "+n.key+"=?",l,function(e,n){var r=0!==n.rowsAffected;return t?t(r):r})}var u=function(e){var t;return t=e._isInDb?c(e,function(t){return t?s(e,!1):i(e)}):i(e,function(t){return t?s(e,!0):c(e)}),t.then(function(t){console.assert(t),t&&(e._changes=0,e._isInDb=!0)})};return Promise.all(e.map(u)).then(t,n)})})}};t.exports=a},{"./model":"/Users/aolson/Developer/updraft/src/model.js","./util":"/Users/aolson/Developer/updraft/src/util.js"}],"/Users/aolson/Developer/updraft/src/util.js":[function(e,t){"use strict";function n(e,t){return 0===e.lastIndexOf(t,0)}function r(e){var t;if(null===e||"object"!=typeof e)return e;if(e instanceof Array){t=[];for(var n=0,o=e.length;o>n;n++)t[n]=r(e[n]);return t}if(e instanceof Object){t={};for(var s in e)e.hasOwnProperty(s)&&(t[s]=r(e[s]));return t}throw new Error("Unable to copy obj! Its type isn't supported.")}t.exports.startsWith=n,t.exports.clone=r},{}]},{},["./src/main.js"]);
//# sourceMappingURL=updraft.min.js.map