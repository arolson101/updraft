/*! updraft 05-12-2014 */
!function(a,b){"use strict";function c(a,b){return 0===a.lastIndexOf(b,0)}var d={},e=function(a,b){if(!a){if(b=b||"Assertion failed","undefined"!=typeof Error)throw new Error(b);throw b}};"function"==typeof a.assert&&(e=a.assert);var f={"int":"INTEGER",bool:"BOOL",real:"REAL",text:"TEXT",blob:"BLOB",date:"DATE",datetime:"DATETIME",ref:"INTEGER"};d.Store=function(){function d(a,b,c,d){return console.log(b,c),new Promise(function(e,f){try{a.executeSql(b,c,function(a,b){var c=d?d(a,b):null;e(c)},function(a,b){h(b),f(b)})}catch(g){throw console.log(g),g}})}function g(a,b,c){return new Promise(function(e,f){o.db.readTransaction(function(g){return d(g,a,b,c).then(e,f)})})}function h(a){switch(a.code){case a.SYNTAX_ERR:console.log("Syntax error: "+a.message);break;default:console.log(a)}}function i(a){var b={},c=a.match(/\((.*)\)/);if(c)for(var d=c[1].split(","),e=0;e<d.length;e++){var f=/^\s*(primary|foreign)\s+key/i;if(!d[e].match(f)){var g=/"(.+)"\s+(.*)/,h=/(\w+)\s+(.*)/,i=d[e].match(g);i||(i=d[e].match(h)),i&&(b[i[1]]=i[2])}}return b}function j(a){return new Promise(function(b,c){o.db.transaction(function(d){return Promise.all(o.templates.map(function(b){return k(d,a,b)})).then(b,c)})})}function k(a,c,g){var h=function(a,b){e(b.type in f);var c=a+" "+f[b.type];return g.key===a&&(c+=" PRIMARY KEY"),c},i=function(b){var c=[];for(var e in g.columns)c.push(h(e,g.columns[e]));return d(a,"CREATE "+(g.temp?"TEMP ":"")+"TABLE "+g.tableName+" ("+c.join(", ")+")",[],b)};if(!(g.tableName in c))return i();if(g.recreate){var j=function(b){return d(a,"DROP TABLE "+g.tableName,[],b)};return j(function(){i()})}var k=c[g.tableName],o=l(k,g),p=m(k,g),q=n(k,g);if(p.length>0||q.length>0){var r=g.tableName+"_old",s=function(b){return d(a,"DROP TABLE IF EXISTS "+r,[],b)},t=function(b){return d(a,"ALTER TABLE "+g.tableName+" RENAME TO "+r,[],b)},u=function(c){var e=Object.keys(k).filter(function(a){return a in g.columns||a in p}),f=e.map(function(a){return a in p?p[a]:a}),h="INSERT INTO "+g.tableName+" ("+f.join(", ")+") ";return h+="SELECT "+e.join(", ")+" FROM "+r+";",d(a,h,[],function(){return c?c():b})};return s(function(){t(function(){i(function(){u(function(){s()})})})})}return o.length>0?Promise.all(o.map(function(b){return d(a,"ALTER TABLE "+g.tableName+" ADD COLUMN "+h(b,g.columns[b]),[])})):void 0}function l(a,b){var c=[];for(var d in b.columns)d in a||c.push(d);return c}function m(a,b){var c=b.renamedColumns||{};for(var d in Object.keys(c))d in a||delete c[d];return c}function n(a,b){return Object.keys(a).filter(function(a){return!(a in b.columns)})}var o=this;this.templates=[],this.createClass=function(a){function b(a,b,c){var d="_"+b;Object.defineProperty(a.prototype,b,{get:function(){return this[d]},set:function(a){this[d]!==a&&(this[d]=a,this._changes|=c)}})}e(a.tableName),e("_"!==a.tableName[0]),e(a.columns),e(Object.keys(a.columns).length<64),e(!("changes"in a.columns)),e(!("template"in a.columns)),e(!a.renamedColumns||Object.keys(a.renamedColumns).every(function(b){return!(b in a.columns)})),a.key=null,Object.keys(a.columns).forEach(function(b){a.columns[b].key&&(a.key=b)}),e(a.key);var c=function(a){this._changes=0,a=a||{};for(var b in a)this[b]=a[b]};c.all=function(){var b=Object.keys(a.columns);return g("SELECT "+b.join(", ")+" FROM "+a.tableName,[],function(a,b){for(var d=[],e=0;e<b.rows.length;e++){var f=new c(b.rows.item(e));f._changes=0,f._isInDb=!0,d.push(f)}return d})},c.get=function(b){var d=Object.keys(a.columns);return g("SELECT "+d.join(", ")+" FROM "+a.tableName+" WHERE "+a.key+"=?",[b],function(a,b){if(e(b.rows.length<2),0===b.rows.length)return null;var d=new c(b.rows.item(0));return d._changes=0,d._isInDb=!0,d})},c.prototype.changes=function(){var b=[],c=0;for(var d in a.columns){var e=1<<c++;this._changes&e&&b.push(d)}return b},c.prototype.template=function(){return a};var d=0;for(var f in a.columns){var h=1<<d++;if(b(c,f,h),d>=63)throw new Error("class has too many columns- max 63")}return o.templates.push(a),c},this.open=function(b){return o.db=a.openDatabase(b.name,"1.0","updraft created database",5242880),o.readSchema().then(j)},this.close=function(){o.db=null,o.templates=[]},this.readSchema=function(){return new Promise(function(a,b){o.db.readTransaction(function(e){d(e,"SELECT name, type, sql FROM sqlite_master",[],function(a,b){for(var d={_indices:[]},e=0;e<b.rows.length;e++){var f=b.rows.item(e);if("_"!=f.name[0]&&!c(f.name,"sqlite"))switch(f.type){case"table":d[f.name]=i(f.sql);break;case"index":d._indices.push(f.name)}}return d}).then(a,b)})})},this.save=function(a){return a.map(function(a){e(a[a.template().key],"object must have a key")}),new Promise(function(b,c){o.db.transaction(function(f){var g=function(a,b){var c=a.template(),e=Object.keys(c.columns),g=e.join(", "),h=e.map(function(){return"?"}).join(", "),i=e.map(function(b){return a[b]});return d(f,"INSERT OR IGNORE INTO "+c.tableName+" ("+g+") VALUES ("+h+")",i,function(a,c){var d=0!==c.rowsAffected;return b?b(d):d})},h=function(a,b){var c=a.template(),e=a.changes(),g=e.map(function(a){return a+"=?"}).join(", "),h=e.map(function(b){return a[b]});return h.push(a[c.key]),d(f,"UPDATE OR IGNORE "+c.tableName+" SET "+g+" WHERE "+c.key+"=?",h,function(a,c){var d=0!==c.rowsAffected;return b?b(d):d})},i=function(a){return h(a,function(b){return b?b:g(a)}).then(function(a){e(a)})},j=function(a){return g(a,function(b){return b?b:h(a)}).then(function(a){e(a)})},k=function(a){a._isInDb?i(a):j(a)},l=function(){a.forEach(function(a){a._changes=0,a._isInDb=!0})};Promise.all(a.map(k)).then(l).then(b,c)})})}},d.VERSION="0.0.1",a.Updraft=d}(this);