!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var t;"undefined"!=typeof window?t=window:"undefined"!=typeof global?t=global:"undefined"!=typeof self&&(t=self),t.Updraft=e()}}(function(){return function e(t,n,r){function s(a,i){if(!n[a]){if(!t[a]){var c="function"==typeof require&&require;if(!i&&c)return c(a,!0);if(o)return o(a,!0);var u=new Error("Cannot find module '"+a+"'");throw u.code="MODULE_NOT_FOUND",u}var l=n[a]={exports:{}};t[a][0].call(l.exports,function(e){var n=t[a][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[a].exports}for(var o="function"==typeof require&&require,a=0;a<r.length;a++)s(r[a]);return s}({"./src/main.js":[function(e,t){"use strict";var n={Store:e("./store")};t.exports=n},{"./store":"/Users/aolson/Developer/updraft/src/store.js"}],"/Users/aolson/Developer/updraft/src/model.js":[function(e,t){"use strict";function n(e){var t=this;t._changes=0,e=e||{};for(var n in e)t[n]=e[n]}function r(e,t){console.assert(e),console.assert(t),console.assert(t.tableName),console.assert("_"!==t.tableName[0]),console.assert(t.columns),console.assert(Object.keys(t.columns).length<64),console.assert(!("changes"in t.columns)),console.assert(!("template"in t.columns)),console.assert(!t.renamedColumns||Object.keys(t.renamedColumns).every(function(e){return!(e in t.columns)}));var a=function(){n.apply(this,arguments),"function"==typeof t.constructor&&t.constructor.call(this)};a.prototype=Object.create(n.prototype),a.prototype.constructor=a;var c=function(e){return new a(e)};Object.setPrototypeOf(c,r.prototype),Object.defineProperty(a.prototype,"model",{enumerable:!0,value:c}),Object.defineProperty(a.prototype,"factory",{enumerable:!0,value:c}),c.ModelInstance=a,Object.defineProperty(c,"store",{enumerable:!0,value:e}),Object.defineProperty(c,"all",{get:function(){return new o(this,this.store)}}),c.indices=[];for(var u in t)c[u]=s.clone(t[u]);c.key=null,c.keyType=null;var l=0;for(var f in c.columns){c.columns[f].key&&(c.key=f,c.keyType=c.columns[f].type),c.columns[f].index&&c.indices.push([f]);var h=1<<l++;if(i(c,a.prototype,f,h),l>=63)throw new Error("class has too many columns- max 63")}return console.assert(c.key),c}var s=e("./util"),o=e("./query"),a=e("./set");n.prototype.key=function(){var e="_"+this.model.key;return console.assert(e in this),this[e]},n.prototype.changes=function(){var e=[],t=0;for(var n in this.model.columns){var r=1<<t++;this._changes&r&&e.push(n)}return e},n.prototype.clearChanges=function(){this._changes=0;for(var e in this.model.columns)"set"===this.model.columns[e].type&&this["_"+e]&&this[e].clearChanges()};var i=function(e,t,n,r){var o="_"+n;switch(e.columns[n].type){default:Object.defineProperty(t,n,{get:function(){return this[o]},set:function(e){this[o]!==e&&(this[o]=e,this._changes|=r)}});break;case"ptr":Object.defineProperty(t,n,{get:function(){var e=this.model.columns[n].ref;console.assert(e.get);var t={};return t.ref=e,t.own=this,t[e.key]=this[o],t.get=function(){return this.ref.get(this.own[o])},t},set:function(e){e=s.keyOf(e),this[o]!==e&&(this[o]=e,this._changes|=r)}});break;case"set":Object.defineProperty(t,n,{get:function(){if(!(o in this)){var e=this;this[o]=new a(function(){e._changes|=r})}return this[o]},set:function(e){if(!(o in this)){var t=this;this[o]=new a(function(){t._changes|=r})}this[o].assign(e),this._changes|=r}})}};r.prototype.get=function(e){return this.all.where(this.key,"=",e).get().then(function(e){return console.assert(e.length<2),0===e.length?null:e[0]})},r.prototype.constructFromDb=function(e){var t=new this.ModelInstance;for(var n in e){var r=e[n],s="_"+n;switch(this.columns[n].type){case"json":t[s]=JSON.parse(r);break;case"date":case"datetime":t[s]=new Date(1e3*r);break;case"enum":var o=t.model.columns[n].enum;console.assert(o&&o.get),t[s]=o.get(r);break;case"set":t[s].push(r);break;default:t[s]=r}}return t._isInDb=!0,console.assert(0===t._changes),t},t.exports=r},{"./query":"/Users/aolson/Developer/updraft/src/query.js","./set":"/Users/aolson/Developer/updraft/src/set.js","./util":"/Users/aolson/Developer/updraft/src/util.js"}],"/Users/aolson/Developer/updraft/src/query.js":[function(e,t){"use strict";var n=e("./util"),r=n.keyOf,s=function(e,t){console.assert(e),console.assert(t),this._model=e,this._store=t,this._justCount=!1,this._tables=[e.tableName],this._columns=[],this._conditions=[],this._order=void 0,this._limit=void 0,this._offset=void 0,this._asc=!0,this._nocase=!1;for(var n in e.columns)"set"!==e.columns[n].type&&this._columns.push(e.tableName+"."+n)};s.prototype.all=function(){return this.get()},s.prototype.addCondition=function(e,t,n,s){var o,a=t.split(/\./),i=this._model;s=r(s);for(var c=0;c<a.length-1;c++){o=a[c],console.assert(o in i.columns);var u=i.columns[o].ref;console.assert(u),-1===this._tables.indexOf(u.tableName)&&(this._tables.push(u.tableName),this._conditions.push({conj:"AND",col:i.tableName+"."+o,op:"=",val:u.tableName+"."+u.key})),i=u}switch(o=a[a.length-1],n){case"contains":console.assert("set"===i.columns[o].type);var l=i.columns[o].setTable;console.assert(l),-1===this._tables.indexOf(l.tableName)&&(this._tables.push(l.tableName),this._conditions.push({conj:"AND",col:i.tableName+"."+i.key,op:"=",val:l.tableName+"."+i.key})),this._conditions.push({conj:e,col:l.tableName+"."+o,op:"=",val:"?",arg:s});break;default:console.assert("set"!==i.columns[o].type),this._conditions.push({conj:e,col:i.tableName+"."+o,op:n,val:"?",arg:s})}return this},s.prototype.and=function(e,t,n){return this.addCondition("AND",e,t,n)},s.prototype.where=s.prototype.and,s.prototype.or=function(e,t,n){return this.addCondition("OR",e,t,n)},s.prototype.order=function(e,t){return this._order=this._model.tableName+"."+e,"undefined"!=typeof t&&(this._asc=t),this},s.prototype.nocase=function(){return this._nocase=!0,this},s.prototype.limit=function(e){return this._limit=e,this},s.prototype.offset=function(e){return this._offset=e,this},s.prototype.count=function(){return this._justCount=!0,this.get()},s.prototype.get=function(){var e="COUNT(*)",t="SELECT ",n=this._model;t+=this._justCount?e:this._columns.join(", "),t+=" FROM "+this._tables.join(", ");for(var r=[],s=0;s<this._conditions.length;s++){var o=this._conditions[s];t+=0===s?" WHERE ":" "+o.conj+" ",t+=o.col+" "+o.op+" "+o.val,"arg"in o&&r.push(o.arg)}this._order&&(t+=" ORDER BY "+this._order,t+=this._nocase?" COLLATE NOCASE":"",t+=this._asc?" ASC":" DESC"),console.assert(!this._offset||this._limit),this._limit&&(t+=" LIMIT "+this._limit,this._offset&&(t+=" OFFSET "+this._offset));var a=[],i=this;return this._store.execRead(t,r,function(t,r){if(i._justCount)return r.rows.item(0)[e];for(var s=0;s<r.rows.length;s++){var o=n.constructFromDb(r.rows.item(s));a.push(o)}return Promise.all(a.map(function(e){return Promise.all(Object.keys(n.columns).filter(function(e){return"set"===n.columns[e].type}).map(function(r){var s=n.columns[r].setTable;console.assert(s);var o=e.key(),a="SELECT "+r;return a+=" FROM "+s.tableName,a+=" WHERE "+i._model.key+" = ?",i._store.exec(t,a,[o],function(t,n){n.rows.length>0&&e[r].initFromDb(n)})}))})).then(function(){return a})})},t.exports=s},{"./util":"/Users/aolson/Developer/updraft/src/util.js"}],"/Users/aolson/Developer/updraft/src/set.js":[function(e,t){"use strict";function n(e){this.dirtyFcn=e,this._values={}}var r=e("./util"),s={saved:2,added:4,removed:8};n.prototype.initFromDb=function(e){for(var t=0;t<e.rows.length;t++){var n=e.rows.item(t);console.assert(1===Object.keys(n).length);var r=n[Object.keys(n)[0]];this._values[r]=s.saved}},n.prototype.assign=function(e){this.clear(),this.add.apply(this,e)},n.prototype.clear=function(){for(var e in this._values)this._values[e]=s.removed},n.prototype.add=function(){var e=!1,t=this;Array.prototype.slice.call(arguments).map(r.keyOf).forEach(function(n){console.assert("object"!=typeof n),t._values[n]!==s.saved&&(t._values[n]=s.added,e=!0)}),e&&this.dirtyFcn()},n.prototype.push=function(){return this.add.apply(this,arguments)},n.prototype.remove=function(){var e=!1,t=this;Array.prototype.slice.call(arguments).map(r.keyOf).forEach(function(n){t._values[n]=s.removed,e=!0}),e&&this.dirtyFcn()},n.prototype.which=function(e){var t=this;return Object.keys(this._values).filter(function(n){return t._values[n]&e})},n.prototype.values=function(){return this.which(s.saved|s.added)},n.prototype.getAdded=function(){return this.which(s.added)},n.prototype.getRemoved=function(){return this.which(s.removed)},n.prototype.clearChanges=function(){var e={};for(var t in this._values)this._values[t]!==s.removed&&(e[t]=s.saved);this._values=e},t.exports=n},{"./util":"/Users/aolson/Developer/updraft/src/util.js"}],"/Users/aolson/Developer/updraft/src/store.js":[function(e,t){"use strict";var n=e("./util"),r=e("./model"),s=n.clone,o=n.startsWith,a={"int":"INTEGER",bool:"BOOL",real:"REAL",text:"TEXT",string:"TEXT",blob:"BLOB","enum":"TEXT",date:"DATE",datetime:"DATETIME",json:"TEXT",ptr:"ref",set:""},i=function(){function e(){u.tables=[],u.triggers={},u.kv={},u.KeyValue=u.createClass({tableName:"updraft_kv",columns:{key:{type:"string",key:"true"},value:{type:"string"}}})}function t(){return u.KeyValue.all.get().then(function(e){for(var t=0;t<e.length;t++){var n=e[t];u.kv[n.key]=JSON.parse(n.value)}})}function n(e){switch(e.code){case e.SYNTAX_ERR:console.log("Syntax error: "+e.message);break;default:console.log(e)}}function i(e){return console.assert(u.db),new Promise(function(t,n){u.db.transaction(function(r){return Promise.all(u.tables.map(function(t){return c(r,e,t)})).then(t,n)})})}function c(e,t,n){function r(t){var r=[];for(var s in n.columns){var o,i=n.columns[s];switch(console.assert(i.type in a),i.type){case"ptr":console.assert(i.ref),console.assert(i.ref.columns),console.assert(i.ref.tableName),console.assert(i.ref.key);var c=i.ref.columns[i.ref.key].type;console.assert(c in a),o=s+" "+a[c],r.push(o);break;case"set":break;default:console.assert(i.type in a),o=s+" "+a[i.type],n.key===s&&(o+=" PRIMARY KEY"),r.push(o)}}return u.exec(e,"CREATE "+(n.temp?"TEMP ":"")+"TABLE "+t+" ("+r.join(", ")+")")}function o(t){return u.exec(e,"DROP TABLE "+t)}function i(r){var o=Promise.resolve(),a=n.tableName in t?s(t[n.tableName]._indices):{};return n.indices.forEach(function(s){var i="index_"+n.tableName+"__"+s.join("_"),c="CREATE INDEX "+i+" ON "+n.tableName+" ("+s.join(", ")+")";delete a[i];var l=!0,f=!1;t[n.tableName]&&t[n.tableName]._indices&&t[n.tableName]._indices[i]&&(t[n.tableName]._indices[i]===c?l=!1:f=!0),f&&(o=o.then(u.exec(e,"DROP INDEX "+i))),(l||r)&&(o=o.then(u.exec(e,c)))}),Object.keys(a).forEach(function(t){o=o.then(u.exec(e,"DROP INDEX "+t))}),o}if(n.tableName in t){if(n.recreate)return Promise.resolve().then(o(n.tableName)).then(r(n.tableName)).then(i(!0));var c=s(t[n.tableName]);delete c._indices,delete c._triggers;var l,f=[],h=!1;for(l in n.columns)l in c||(f.push(l),n.columns[l].ref&&(h=!0));var p=s(n.renamedColumns)||{};for(l in Object.keys(p))l in c||delete p[l];var m=Object.keys(c).filter(function(e){return!(e in n.columns)});if(h||Object.keys(p).length>0||m.length>0){var d=function(t,r){var s=Object.keys(c).filter(function(e){return e in n.columns||e in p}),o=s.map(function(e){return e in p?p[e]:e});if(s.length&&o.length){var a="INSERT INTO "+r+" ("+o.join(", ")+") ";return a+="SELECT "+s.join(", ")+" FROM "+t+";",u.exec(e,a)}},y=function(t,n){return u.exec(e,"ALTER TABLE "+t+" RENAME TO "+n)},v="new_"+n.tableName;return console.assert(!(v in t)),Promise.resolve().then(r(v)).then(d(n.tableName,v)).then(o(n.tableName)).then(y(v,n.tableName)).then(i(!0))}if(f.length>0){var b=Promise.resolve();return f.map(function(t){var r=n.columns[t];console.assert(r.type in a);var s=t+" "+a[r.type];b=b.then(u.exec(e,"ALTER TABLE "+n.tableName+" ADD COLUMN "+s))}),b.then(i())}return i()}return Promise.resolve().then(r(n.tableName)).then(i(!0))}var u=this;this.logSql=!1,this.columnType=a,this.createClass=function(e){var t=new r(u,e);return u.tables.push(t),t},this.set=function(e,t){this.kv[e]=t;var n=new this.KeyValue({key:e,value:JSON.stringify(t)});return this.save(n)},this.get=function(e){return this.kv[e]},this.purge=function(e){return console.assert(!u.db),u.db=window.openDatabase(e.name,"1.0","updraft created database",5242880),console.assert(u.db),u.readSchema().then(function(e){return new Promise(function(t,n){u.db.transaction(function(r){var s=Promise.resolve();return Object.keys(e).forEach(function(e){s=s.then(u.exec(r,"DROP TABLE "+e))}),s.then(function(){u.db=null}).then(t,n)})})})},this.open=function(e){u.db=window.openDatabase(e.name,"1.0","updraft created database",5242880),console.assert(u.db);for(var n=[],r=0;r<u.tables.length;r++){var s=u.tables[r];for(var o in s.columns)if("set"===s.columns[o].type){var a=s.columns[o].ref,c=a.keyType?a.keyType:c;console.assert(a);var l={};l.tableName=s.tableName+"_"+o,l.recreate=s.recreate,l.temp=s.temp,l.key="",l.keyType=s.keyType,l.columns={},l.columns[s.key]={type:s.keyType},l.columns[o]={type:c},l.indices=[[s.key],[o]],s.columns[o].setTable=l,n.push(l)}}return u.tables=u.tables.concat(n),u.readSchema().then(i).then(t)},this.close=function(){u.db=null,e()},this.exec=function(e,t,r,s){return u.logSql&&console.log(t,r),new Promise(function(o,a){try{e.executeSql(t,r,function(e,t){var n=s?s(e,t):null;return Promise.resolve(n).then(o,a)},function(e,t){n(t),a(t)})}catch(i){throw console.log('Failed to exec "'+t+'":'+i),i}})},this.execRead=function(e,t,n){return console.assert(u.db),new Promise(function(r,s){u.db.readTransaction(function(o){return u.exec(o,e,t,n).then(r,s)})})},this.readSchema=function(){function e(e){var t={_indices:{},_triggers:{}},n=e.match(/\((.*)\)/);if(n)for(var r=n[1].split(","),s=0;s<r.length;s++){var o=/^\s*(primary|foreign)\s+key/i;if(!r[s].match(o)){var a=/"(.+)"\s+(.*)/,i=/(\w+)\s+(.*)/,c=r[s].match(a);c||(c=r[s].match(i)),c&&(t[c[1]]=c[2])}}return t}return u.execRead("SELECT name, tbl_name, type, sql FROM sqlite_master",[],function(t,n){for(var r={},s=0;s<n.rows.length;s++){var a=n.rows.item(s);if("_"!=a.name[0]&&!o(a.name,"sqlite"))switch(a.type){case"table":r[a.name]=e(a.sql);break;case"index":r[a.tbl_name]._indices=r[a.tbl_name]._indices||{},r[a.tbl_name]._indices[a.name]=a.sql;break;case"trigger":r[a.tbl_name]._triggers=r[a.tbl_name]._triggers||{},r[a.tbl_name]._triggers[a.name]=a.sql}}return r})},this.save=function(e){return e instanceof Array||(e=[e]),e.map(function(e){console.assert("_"+e.model.key in e,"object must have a key")}),new Promise(function(t,n){u.db.transaction(function(r){function s(e,t){var n=e["_"+t];switch(e.model.columns[t].type){case"date":case"datetime":"undefined"!=typeof n&&(console.assert(n instanceof Date),n=Math.floor(n.getTime()/1e3));break;case"json":n=JSON.stringify(n);break;case"enum":console.assert(e.model.columns[t].enum),n=n.toString();break;default:console.assert("object"!=typeof n)}return n}function o(e,t){var n=e.changes(),s=e.model,o=[];return Object.keys(s.columns).filter(function(e){return"set"===s.columns[e].type&&(t||n.indexOf(e)>-1)}).forEach(function(t){var n=s.columns[t].ref,a=s.columns[t].setTable;console.assert(n),console.assert(a);var i=e["_"+t];if(i){var c=e.key(),l=i.getRemoved(),f=i.getAdded();l.forEach(function(e){o.push(u.exec(r,"DELETE FROM "+a.tableName+" WHERE "+s.key+"=? AND "+t+"=?",[c,e]))}),f.forEach(function(e){o.push(u.exec(r,"INSERT INTO "+a.tableName+" ("+s.key+", "+t+") VALUES (?, ?)",[c,e]))})}}),Promise.all(o)}function a(e,t){var n=e.model,o=function(e){return"set"!==n.columns[e].type},a=Object.keys(n.columns).filter(o),i=a.join(", "),c=a.map(function(){return"?"}).join(", "),l=a.map(function(t){return s(e,t)});return u.exec(r,"INSERT OR IGNORE INTO "+n.tableName+" ("+i+") VALUES ("+c+")",l,function(e,n){var r=0!==n.rowsAffected;return t?t(r):r})}function i(e,t){var n=e.model,o=e.changes(),a=function(e){return"set"!==n.columns[e].type},i=function(e){return e!==n.key},c=o.filter(a).filter(i).map(function(e){return e+"=?"}).join(", "),l=o.filter(a).filter(i).map(function(t){return s(e,t)});return l.push(e["_"+n.key]),u.exec(r,"UPDATE OR IGNORE "+n.tableName+" SET "+c+" WHERE "+n.key+"=?",l,function(e,n){var r=0!==n.rowsAffected;return t?t(r):r})}var c=function(e){var t;return t=e._isInDb?i(e,function(t){return t?o(e,!1):a(e)}):a(e,function(t){return t?o(e,!0):i(e)}),t.then(function(t){console.assert(t),t&&(e.clearChanges(),e._isInDb=!0)})};return Promise.all(e.map(c)).then(t,n)})})},e()};t.exports=i},{"./model":"/Users/aolson/Developer/updraft/src/model.js","./util":"/Users/aolson/Developer/updraft/src/util.js"}],"/Users/aolson/Developer/updraft/src/util.js":[function(e,t){"use strict";function n(e,t){return 0===e.lastIndexOf(t,0)}function r(e){var t;if(null===e||"object"!=typeof e)return e;if(e instanceof Array){t=[];for(var n=0,s=e.length;s>n;n++)t[n]=r(e[n]);return t}if(e instanceof Object&&"Object"!==e.constructor.name)return e;if(e instanceof Object&&"Object"===e.constructor.name){t={};for(var o in e)e.hasOwnProperty(o)&&(t[o]=r(e[o]));return t}throw new Error("Unable to copy obj! Its type isn't supported.")}function s(e){return"function"==typeof e.key?e.key():"object"==typeof e&&"function"==typeof e.toString?e.toString():e}t.exports.startsWith=n,t.exports.clone=r,t.exports.keyOf=s},{}]},{},["./src/main.js"])("./src/main.js")});
//# sourceMappingURL=updraft.min.js.map