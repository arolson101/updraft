!function e(t,n,r){function s(i,a){if(!n[i]){if(!t[i]){var c="function"==typeof require&&require;if(!a&&c)return c(i,!0);if(o)return o(i,!0);var u=new Error("Cannot find module '"+i+"'");throw u.code="MODULE_NOT_FOUND",u}var l=n[i]={exports:{}};t[i][0].call(l.exports,function(e){var n=t[i][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)s(r[i]);return s}({"./src/main.js":[function(e,t){"use strict";var n={Store:e("./store")};t.exports=n,window&&(window.Updraft=n)},{"./store":"/Users/aolson/Developer/updraft/src/store.js"}],"/Users/aolson/Developer/updraft/src/model.js":[function(e,t){"use strict";function n(e){var t=this;t._changes=0,e=e||{};for(var n in e)t[n]=e[n]}function r(e,t){console.assert(e),console.assert(t),console.assert(t.tableName),console.assert("_"!==t.tableName[0]),console.assert(t.columns),console.assert(Object.keys(t.columns).length<64),console.assert(!("changes"in t.columns)),console.assert(!("template"in t.columns)),console.assert(!t.renamedColumns||Object.keys(t.renamedColumns).every(function(e){return!(e in t.columns)}));var i=function(){n.apply(this,arguments)};i.prototype=Object.create(n.prototype),i.prototype.constructor=i;var c=function(e){return new i(e)};Object.setPrototypeOf(c,r.prototype),Object.defineProperty(i.prototype,"model",{enumerable:!0,value:c}),Object.defineProperty(i.prototype,"factory",{enumerable:!0,value:c}),c.ModelInstance=i,Object.defineProperty(c,"store",{enumerable:!0,value:e}),Object.defineProperty(c,"all",{get:function(){return new o(this,this.store)}}),c.indices=[];for(var u in t)c[u]=s.clone(t[u]);c.key=null,c.keyType=null;var l=0;for(var f in c.columns){c.columns[f].key&&(c.key=f,c.keyType=c.columns[f].type),c.columns[f].index&&c.indices.push([f]);var h=1<<l++;if(a(c,i.prototype,f,h),l>=63)throw new Error("class has too many columns- max 63")}return console.assert(c.key),c}var s=e("./util"),o=e("./query"),i=e("./set");n.prototype.key=function(){var e="_"+this.model.key;return console.assert(e in this),this[e]},n.prototype.changes=function(){var e=[],t=0;for(var n in this.model.columns){var r=1<<t++;this._changes&r&&e.push(n)}return e},n.prototype.clearChanges=function(){this._changes=0;for(var e in this.model.columns)"set"===this.model.columns[e].type&&this["_"+e]&&this[e].clearChanges()};var a=function(e,t,n,r){var o="_"+n;switch(e.columns[n].type){default:Object.defineProperty(t,n,{get:function(){return this[o]},set:function(e){this[o]!==e&&(this[o]=e,this._changes|=r)}});break;case"ptr":Object.defineProperty(t,n,{get:function(){var e=this.model.columns[n].ref;console.assert(e.get);var t={};return t.ref=e,t.own=this,t[e.key]=this[o],t.get=function(){return this.ref.get(this.own[o])},t},set:function(e){e=s.keyOf(e),this[o]!==e&&(this[o]=e,this._changes|=r)}});break;case"set":Object.defineProperty(t,n,{get:function(){if(!(o in this)){var e=this;this[o]=new i(function(){e._changes|=r})}return this[o]},set:function(e){if(!(o in this)){var t=this;this[o]=new i(function(){t._changes|=r})}this[o].assign(e),this._changes|=r}})}};r.prototype.get=function(e){return this.all.where(this.key,"=",e).get().then(function(e){return console.assert(e.length<2),0===e.length?null:e[0]})},r.prototype.constructFromDb=function(e){var t=new this.ModelInstance;for(var n in e){var r=e[n],s="_"+n;switch(this.columns[n].type){case"json":t[s]=JSON.parse(r);break;case"set":t[s].push(r);break;default:t[s]=r}}return t._isInDb=!0,console.assert(0===t._changes),t},t.exports=r},{"./query":"/Users/aolson/Developer/updraft/src/query.js","./set":"/Users/aolson/Developer/updraft/src/set.js","./util":"/Users/aolson/Developer/updraft/src/util.js"}],"/Users/aolson/Developer/updraft/src/query.js":[function(e,t){"use strict";var n=e("./util"),r=n.keyOf,s=function(e,t){console.assert(e),console.assert(t),this._model=e,this._store=t,this._justCount=!1,this._tables=[e.tableName],this._columns=[],this._conditions=[],this._order=void 0,this._limit=void 0,this._offset=void 0,this._asc=!0,this._nocase=!1;for(var n in e.columns)"set"!==e.columns[n].type&&this._columns.push(e.tableName+"."+n)};s.prototype.all=function(){return this.get()},s.prototype.addCondition=function(e,t,n,s){var o,i=t.split(/\./),a=this._model;s=r(s);for(var c=0;c<i.length-1;c++){o=i[c],console.assert(o in a.columns);var u=a.columns[o].ref;console.assert(u),-1===this._tables.indexOf(u.tableName)&&(this._tables.push(u.tableName),this._conditions.push({conj:"AND",col:a.tableName+"."+o,op:"=",val:u.tableName+"."+u.key})),a=u}switch(o=i[i.length-1],n){case"contains":console.assert("set"===a.columns[o].type);var l=a.columns[o].setTable;console.assert(l),-1===this._tables.indexOf(l.tableName)&&(this._tables.push(l.tableName),this._conditions.push({conj:"AND",col:a.tableName+"."+a.key,op:"=",val:l.tableName+"."+a.key})),this._conditions.push({conj:e,col:l.tableName+"."+o,op:"=",val:"?",arg:s});break;default:console.assert("set"!==a.columns[o].type),this._conditions.push({conj:e,col:a.tableName+"."+o,op:n,val:"?",arg:s})}return this},s.prototype.and=function(e,t,n){return this.addCondition("AND",e,t,n)},s.prototype.where=s.prototype.and,s.prototype.or=function(e,t,n){return this.addCondition("OR",e,t,n)},s.prototype.order=function(e,t){return this._order=this._model.tableName+"."+e,"undefined"!=typeof t&&(this._asc=t),this},s.prototype.nocase=function(){return this._nocase=!0,this},s.prototype.limit=function(e){return this._limit=e,this},s.prototype.offset=function(e){return this._offset=e,this},s.prototype.count=function(){return this._justCount=!0,this.get()},s.prototype.get=function(){var e="COUNT(*)",t="SELECT ",n=this._model;t+=this._justCount?e:this._columns.join(", "),t+=" FROM "+this._tables.join(", ");for(var r=[],s=0;s<this._conditions.length;s++){var o=this._conditions[s];t+=0===s?" WHERE ":" "+o.conj+" ",t+=o.col+" "+o.op+" "+o.val,"arg"in o&&r.push(o.arg)}this._order&&(t+=" ORDER BY "+this._order,t+=this._nocase?" COLLATE NOCASE":"",t+=this._asc?" ASC":" DESC"),console.assert(!this._offset||this._limit),this._limit&&(t+=" LIMIT "+this._limit,this._offset&&(t+=" OFFSET "+this._offset));var i=[],a=this;return this._store.execRead(t,r,function(t,r){if(a._justCount)return r.rows.item(0)[e];for(var s=0;s<r.rows.length;s++){var o=n.constructFromDb(r.rows.item(s));i.push(o)}return Promise.all(i.map(function(e){return Promise.all(Object.keys(n.columns).filter(function(e){return"set"===n.columns[e].type}).map(function(r){var s=n.columns[r].setTable;console.assert(s);var o=e.key(),i="SELECT "+r;return i+=" FROM "+s.tableName,i+=" WHERE "+a._model.key+" = ?",a._store.exec(t,i,[o],function(t,n){n.rows.length>0&&e[r].initFromDb(n)})}))})).then(function(){return i})})},t.exports=s},{"./util":"/Users/aolson/Developer/updraft/src/util.js"}],"/Users/aolson/Developer/updraft/src/set.js":[function(e,t){"use strict";function n(e){this.dirtyFcn=e,this._values={}}var r=e("./util"),s={saved:2,added:4,removed:8};n.prototype.initFromDb=function(e){for(var t=0;t<e.rows.length;t++){var n=e.rows.item(t);console.assert(1===Object.keys(n).length);var r=n[Object.keys(n)[0]];this._values[r]=s.saved}},n.prototype.assign=function(e){this.clear(),this.add.apply(this,e)},n.prototype.clear=function(){for(var e in this._values)this._values[e]=s.removed},n.prototype.add=function(){var e=!1,t=this;Array.prototype.slice.call(arguments).map(r.keyOf).forEach(function(n){console.assert("object"!=typeof n),t._values[n]!==s.saved&&(t._values[n]=s.added,e=!0)}),e&&this.dirtyFcn()},n.prototype.push=function(){return this.add.apply(this,arguments)},n.prototype.remove=function(){var e=!1,t=this;Array.prototype.slice.call(arguments).map(r.keyOf).forEach(function(n){t._values[n]=s.removed,e=!0}),e&&this.dirtyFcn()},n.prototype.which=function(e){var t=this;return Object.keys(this._values).filter(function(n){return t._values[n]&e})},n.prototype.values=function(){return this.which(s.saved|s.added)},n.prototype.getAdded=function(){return this.which(s.added)},n.prototype.getRemoved=function(){return this.which(s.removed)},n.prototype.clearChanges=function(){var e={};for(var t in this._values)this._values[t]!==s.removed&&(e[t]=s.saved);this._values=e},t.exports=n},{"./util":"/Users/aolson/Developer/updraft/src/util.js"}],"/Users/aolson/Developer/updraft/src/store.js":[function(e,t){"use strict";var n=e("./util"),r=e("./model"),s=n.clone,o=n.startsWith,i={"int":"INTEGER",bool:"BOOL",real:"REAL",text:"TEXT",blob:"BLOB",date:"DATE",datetime:"DATETIME",json:"TEXT",ptr:"ref",set:""},a=function(){function e(e){switch(e.code){case e.SYNTAX_ERR:console.log("Syntax error: "+e.message);break;default:console.log(e)}}function t(e){return console.assert(a.db),new Promise(function(t,r){a.db.transaction(function(s){return Promise.all(a.tables.map(function(t){return n(s,e,t)})).then(t,r)})})}function n(e,t,n){function r(t){var r=[];for(var s in n.columns){var o,c=n.columns[s];switch(console.assert(c.type in i),c.type){case"ptr":console.assert(c.ref),console.assert(c.ref.columns),console.assert(c.ref.tableName),console.assert(c.ref.key);var u=c.ref.columns[c.ref.key].type;console.assert(u in i),o=s+" "+i[u],r.push(o);break;case"set":break;default:console.assert(c.type in i),o=s+" "+i[c.type],n.key===s&&(o+=" PRIMARY KEY"),r.push(o)}}return a.exec(e,"CREATE "+(n.temp?"TEMP ":"")+"TABLE "+t+" ("+r.join(", ")+")")}function o(t){return a.exec(e,"DROP TABLE "+t)}function c(r){var o=Promise.resolve(),i=n.tableName in t?s(t[n.tableName]._indices):{};return n.indices.forEach(function(s){var c="index_"+n.tableName+"__"+s.join("_"),u="CREATE INDEX "+c+" ON "+n.tableName+" ("+s.join(", ")+")";delete i[c];var l=!0,f=!1;t[n.tableName]&&t[n.tableName]._indices&&t[n.tableName]._indices[c]&&(t[n.tableName]._indices[c]===u?l=!1:f=!0),f&&(o=o.then(a.exec(e,"DROP INDEX "+c))),(l||r)&&(o=o.then(a.exec(e,u)))}),Object.keys(i).forEach(function(t){o=o.then(a.exec(e,"DROP INDEX "+t))}),o}if(n.tableName in t){if(n.recreate)return Promise.resolve().then(o(n.tableName)).then(r(n.tableName)).then(c(!0));var u=s(t[n.tableName]);delete u._indices,delete u._triggers;var l,f=[],h=!1;for(l in n.columns)l in u||(f.push(l),n.columns[l].ref&&(h=!0));var p=s(n.renamedColumns)||{};for(l in Object.keys(p))l in u||delete p[l];var m=Object.keys(u).filter(function(e){return!(e in n.columns)});if(h||Object.keys(p).length>0||m.length>0){var d=function(t,r){var s=Object.keys(u).filter(function(e){return e in n.columns||e in p}),o=s.map(function(e){return e in p?p[e]:e}),i="INSERT INTO "+r+" ("+o.join(", ")+") ";return i+="SELECT "+s.join(", ")+" FROM "+t+";",a.exec(e,i)},y=function(t,n){return a.exec(e,"ALTER TABLE "+t+" RENAME TO "+n)},v="new_"+n.tableName;return console.assert(!(v in t)),Promise.resolve().then(r(v)).then(d(n.tableName,v)).then(o(n.tableName)).then(y(v,n.tableName)).then(c(!0))}if(f.length>0){var b=Promise.resolve();return f.map(function(t){var r=n.columns[t];console.assert(r.type in i);var s=t+" "+i[r.type];b=b.then(a.exec(e,"ALTER TABLE "+n.tableName+" ADD COLUMN "+s))}),b.then(c())}return c()}return Promise.resolve().then(r(n.tableName)).then(c(!0))}var a=this;this.tables=[],this.triggers={},this.logSql=!1,this.columnType=i,this.createClass=function(e){var t=new r(a,e);return a.tables.push(t),t},this.purge=function(e){return console.assert(!a.db),a.db=window.openDatabase(e.name,"1.0","updraft created database",5242880),console.assert(a.db),a.readSchema().then(function(e){return new Promise(function(t,n){a.db.transaction(function(r){var s=Promise.resolve();return Object.keys(e).forEach(function(e){s=s.then(a.exec(r,"DROP TABLE "+e))}),s.then(function(){a.db=null}).then(t,n)})})})},this.open=function(e){a.db=window.openDatabase(e.name,"1.0","updraft created database",5242880),console.assert(a.db);for(var n=[],r=0;r<a.tables.length;r++){var s=a.tables[r];for(var o in s.columns)if("set"===s.columns[o].type){var i=s.columns[o].ref,c=i.keyType?i.keyType:c;console.assert(i);var u={};u.tableName=s.tableName+"_"+o,u.recreate=s.recreate,u.temp=s.temp,u.key="",u.keyType=s.keyType,u.columns={},u.columns[s.key]={type:s.keyType},u.columns[o]={type:c},u.indices=[[s.key],[o]],s.columns[o].setTable=u,n.push(u)}}return a.tables=a.tables.concat(n),a.readSchema().then(t)},this.close=function(){a.db=null,a.tables=[],a.triggers={}},this.exec=function(t,n,r,s){return a.logSql&&console.log(n,r),new Promise(function(o,i){try{t.executeSql(n,r,function(e,t){var n=s?s(e,t):null;return Promise.resolve(n).then(o,i)},function(t,n){e(n),i(n)})}catch(a){throw console.log('Failed to exec "'+n+'":'+a),a}})},this.execRead=function(e,t,n){return console.assert(a.db),new Promise(function(r,s){a.db.readTransaction(function(o){return a.exec(o,e,t,n).then(r,s)})})},this.readSchema=function(){function e(e){var t={_indices:{},_triggers:{}},n=e.match(/\((.*)\)/);if(n)for(var r=n[1].split(","),s=0;s<r.length;s++){var o=/^\s*(primary|foreign)\s+key/i;if(!r[s].match(o)){var i=/"(.+)"\s+(.*)/,a=/(\w+)\s+(.*)/,c=r[s].match(i);c||(c=r[s].match(a)),c&&(t[c[1]]=c[2])}}return t}return a.execRead("SELECT name, tbl_name, type, sql FROM sqlite_master",[],function(t,n){for(var r={},s=0;s<n.rows.length;s++){var i=n.rows.item(s);if("_"!=i.name[0]&&!o(i.name,"sqlite"))switch(i.type){case"table":r[i.name]=e(i.sql);break;case"index":r[i.tbl_name]._indices=r[i.tbl_name]._indices||{},r[i.tbl_name]._indices[i.name]=i.sql;break;case"trigger":r[i.tbl_name]._triggers=r[i.tbl_name]._triggers||{},r[i.tbl_name]._triggers[i.name]=i.sql}}return r})},this.save=function(e){return e.map(function(e){console.assert("_"+e.model.key in e,"object must have a key")}),new Promise(function(t,n){a.db.transaction(function(r){function s(e,t){var n=e["_"+t];return"object"==typeof n&&(n=JSON.stringify(n)),n}function o(e,t){var n=e.changes(),s=e.model,o=[];return Object.keys(s.columns).filter(function(e){return"set"===s.columns[e].type&&(t||n.indexOf(e)>-1)}).forEach(function(t){var n=s.columns[t].ref,i=s.columns[t].setTable;console.assert(n),console.assert(i);var c=e["_"+t];if(c){var u=e.key(),l=c.getRemoved(),f=c.getAdded();l.forEach(function(e){o.push(a.exec(r,"DELETE FROM "+i.tableName+" WHERE "+s.key+"=? AND "+t+"=?",[u,e]))}),f.forEach(function(e){o.push(a.exec(r,"INSERT INTO "+i.tableName+" ("+s.key+", "+t+") VALUES (?, ?)",[u,e]))})}}),Promise.all(o)}function i(e,t){var n=e.model,o=function(e){return"set"!==n.columns[e].type},i=Object.keys(n.columns).filter(o),c=i.join(", "),u=i.map(function(){return"?"}).join(", "),l=i.map(function(t){return s(e,t)});return a.exec(r,"INSERT OR IGNORE INTO "+n.tableName+" ("+c+") VALUES ("+u+")",l,function(e,n){var r=0!==n.rowsAffected;return t?t(r):r})}function c(e,t){var n=e.model,o=e.changes(),i=function(e){return"set"!==n.columns[e].type},c=function(e){return e!==n.key},u=o.filter(i).filter(c).map(function(e){return e+"=?"}).join(", "),l=o.filter(i).filter(c).map(function(t){return s(e,t)});return l.push(e["_"+n.key]),a.exec(r,"UPDATE OR IGNORE "+n.tableName+" SET "+u+" WHERE "+n.key+"=?",l,function(e,n){var r=0!==n.rowsAffected;return t?t(r):r})}var u=function(e){var t;return t=e._isInDb?c(e,function(t){return t?o(e,!1):i(e)}):i(e,function(t){return t?o(e,!0):c(e)}),t.then(function(t){console.assert(t),t&&(e.clearChanges(),e._isInDb=!0)})};return Promise.all(e.map(u)).then(t,n)})})}};t.exports=a},{"./model":"/Users/aolson/Developer/updraft/src/model.js","./util":"/Users/aolson/Developer/updraft/src/util.js"}],"/Users/aolson/Developer/updraft/src/util.js":[function(e,t){"use strict";function n(e,t){return 0===e.lastIndexOf(t,0)}function r(e){var t;if(null===e||"object"!=typeof e)return e;if(e instanceof Array){t=[];for(var n=0,s=e.length;s>n;n++)t[n]=r(e[n]);return t}if(e instanceof Object){t={};for(var o in e)e.hasOwnProperty(o)&&(t[o]=r(e[o]));return t}throw new Error("Unable to copy obj! Its type isn't supported.")}function s(e){return"function"==typeof e.key?e.key():e}t.exports.startsWith=n,t.exports.clone=r,t.exports.keyOf=s},{}]},{},["./src/main.js"]);
//# sourceMappingURL=updraft.min.js.map